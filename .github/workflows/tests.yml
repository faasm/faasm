name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  quick-start:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    env:
      PYTHON_CODEGEN: "on"
    steps:
      # --- Code update ---
      - name: "Check out code"
        uses: actions/checkout@v2
      # --- Setup ---
      - name: "Start docker-compose"
        run: docker-compose up -d
        #- name: "Give time for python codegen to run"
        #  run: sleep 20s
      # --- CPP ---
      - name: "Build cpp function"
        run: docker-compose exec -T cpp inv func demo hello
      - name: "Upload cpp function"
        run: docker-compose exec -T cpp inv func.upload demo hello
      - name: "Invoke cpp function"
        run: docker-compose exec -T cpp inv func.invoke demo hello
      # --- Python ---
      - name: "Build python function"
        run: docker-compose exec -T python inv func
      - name: "Upload python runtime function"
        run: docker-compose exec -T python inv func.upload
      - name: "Upload python hello function"
        run: docker-compose exec -T python inv func.uploadpy hello
      - name: "Invoke python hello function"
        run: docker-compose exec -T python inv func.invoke python hello
      # --- Shutdown ---
      - name: "Stop docker-compose"
        run: docker-compose down
