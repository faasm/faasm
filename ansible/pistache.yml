---

- hosts: localhost
  gather_facts: no
  tasks:
    # Note - make sure the version here matches the edge docker image
    - name: "Clone Pistache"
      git:
        repo: "https://github.com/oktal/pistache.git"
        dest: "/tmp/pistache"
        version: "ccf0ab860760e84832e4d484336fee477458c7d2"

    - name: "Set up build"
      shell: "{{ item }}"
      args:
        chdir: "/tmp/pistache"
      with_items:
      - "git submodule update --init"
      - "mkdir -p build"

    - name: "Build"
      shell: "{{ item }}"
      args:
        chdir: "/tmp/pistache/build"
      with_items:
      - 'cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release ..'
      - "make"

    - name: "Install"
      become: yes
      shell: "{{ item }}"
      args:
        chdir: "/tmp/pistache/build"
      with_items:
        - "sudo make install"
        - "ldconfig"

    - name: "Clean up"
      shell: "rm -rf /tmp/pistache"
