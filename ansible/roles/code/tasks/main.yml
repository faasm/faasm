---

- name: "Ensure group faasm exists"
  become: yes
  group:
    name: faasm
    state: present

- name: Add users to group
  become: yes
  user:
    name: "{{ item }}"
    groups: faasm
    append: yes
  with_items:
    - scs17
    - mfournial

- name: "Set up directory"
  become: yes
  file:
    path: "/usr/local/code"
    state: directory
    group: "faasm"
    mode: 0775

- name: "Install system deps"
  become: yes
  apt:
    name:
      - cmake
      - git

- name: "Check out code"
  git:
    repo: "https://github.com/mfournial/Faasm.git"
    version: "fix-bm"
    dest: /usr/local/code/faasm
    update: yes

# Not supported by ansible: recursively change ownership for dirs and files
- name: "Set directory ownership to faasm"
  become: yes
  command: |
    chown -c -R :faasm "{{ item }}"
  register: chown_status
  changed_when: chown_status.stdout != ""
  with_items:
    - /usr/local/code/faasm

# Not supported by ansible: Allow writes. Ideally we'd want directories to be 775 and files 664
# But submodules are not all configured properly and git tracks the execute bit
- name: "Set code permissions to faasm"
  become: yes
  command: |
    chmod -c -R g=+w "{{ item }}"
  register: chmod_status
  changed_when: chmod_status.stdout != ""
  with_items:
    - /usr/local/code/faasm